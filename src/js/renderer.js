const {
    ipcRenderer
} = require('electron')
const ipc = ipcRenderer



btn.addEventListener("click", () => {
    console.log("click open input url page");
    ipc.send("clickcheckBTNfromMain");
});

// function cleanURL() {
//     let check = document.getElementById("linkToScan").value;
//     // let showResult = document.getElementById("cerResults");

//     // let sslChecker = require("ssl-checker")
//     // let daysRemaining = "Time remaining "+result['daysRemaining']+ " day"
//     // let validate = "Validate = "+result['valid']
//     // let validFrom = "Start valid from "+result['validFrom']
//     // let validTo = "Expire valid to "+result['validTo']


//     console.log('clean URL')
//     let url = ''
//     if (check.includes("://")) {
//         url = new URL(check).hostname
//     } else {
//         url = check
//     }
//     return url
// }


// function certificateChecker() {
//     return new Promise(function (resolve, reject) {
//         setTimeout(function () {

//             // code

//             let check = document.getElementById("linkToScan").value;
//             // let showResult = document.getElementById("cerResults");

//             let sslChecker = require("ssl-checker")


//             // let daysRemaining = "Time remaining "+result['daysRemaining']+ " day"
//             // let validate = "Validate = "+result['valid']
//             // let validFrom = "Start valid from "+result['validFrom']
//             // let validTo = "Expire valid to "+result['validTo']


//             console.log(check)
//             console.log('clean URL')
//             let url = ''
//             if (check.includes("://")){
//                 url = new URL(check).hostname
//             } else {
//                 url = check
//             }


//             // let url = new URL(check).hostname
//             // console.log(url)
//             console.log('yo')




//             // check certificate valid

//             console.log('check certificate valid')

//             // cleanURL().then(function (url) {
//                 console.log(url)
//                 sslChecker(url, "GET", 443).then((result) => {
//                     let res = result["daysRemaining"]
//                     let daysRemaining = "Time remaining " + result["daysRemaining"] + " day";
//                     let validate = "Validate = " + result["valid"];
//                     let validFrom = "Start valid from " + new Date(result["validFrom"]).toLocaleString();
//                     let validTo = "Expire valid to " + new Date(result["validTo"]).toLocaleString();
//                     let validFor = "Valid for " + result["validFor"];

//                     let check_day = Math.sign(result['daysRemaining'])

//                     // console.log(res)
//                     // console.log(daysRemaining)
//                     // console.log(validate)
//                     // console.log(validFrom)
//                     // console.log(validTo)
//                     // console.log(validFor)
//                     // console.log(check_day)

//                     // showResult.innerHTML = daysRemaining;
//                     // document.getElementById("daysRemaining").innerHTML = daysRemaining;
//                     // document.getElementById("validate").innerHTML = validate;
//                     // document.getElementById("validFrom").innerHTML = validFrom;
//                     // document.getElementById("validFrom").innerHTML = validFrom;
//                     // document.getElementById("validTo").innerHTML = validTo;
//                     // document.getElementById("validFor").innerHTML = validFor;

//                     console.log('Math.sign = ' + Math.sign(result['daysRemaining']));
//                     console.log(validate)

//                     if (result["valid"] == true && res == 1) {
//                         switch (Math.sign(result['daysRemaining'])) {
//                             case 1:
//                                 document.getElementById('Certificate_icon').style.color = 'green'
//                                 document.getElementById("dayremaining").innerHTML = res + ' remaining';
//                                 console.log('มันเข้า 1 ด้วย')
//                                 break
//                             case -1:
//                                 document.getElementById('Certificate_icon').style.color = 'red'
//                                 document.getElementById("dayremaining").innerHTML = daysRemaining + ' day expired';
//                                 console.log('มันเข้า -1 ด้วย')
//                                 break
//                             case 0:
//                                 document.getElementById('Certificate_icon').style.color = 'red'
//                                 document.getElementById("dayremaining").innerHTML = 'Today expired';
//                                 console.log('มันเข้า 0 ด้วย')
//                                 break
//                             case -0:
//                                 document.getElementById("dayremaining").innerHTML = '-0';
//                                 console.log('มันเข้า -0 ด้วย')
//                                 break
//                             case NaN:
//                                 document.getElementById("dayremaining").innerHTML = 'NaN';
//                                 console.log('มันเข้า NaN ด้วย')
//                                 break
//                             default:
//                                 document.getElementById("dayremaining").innerHTML = 'อยู่เหนือความคาดหมาย';
//                                 break

//                         }
//                     } else if (result["valid"] == true && check_day == -1) {
//                         document.getElementById('Certificate_icon').style.color = 'red'
//                         document.getElementById("dayremaining").innerHTML = 'not extend validate';
//                     } else if (result["valid"] == false) {
//                         document.getElementById('Certificate_icon').style.color = 'red'
//                         document.getElementById("dayremaining").innerHTML = 'Fake validate';
//                     }


//                     // test only
//                     // document.getElementById('Certificate_icon').style.color = 'green'
//                     // document.getElementById("dayremaining").innerHTML = daysRemaining+' remaining';
//                     // test only

//                 });
//             // })





//             // wrong.host.badssl.com
//             // https://badssl.com/
//             // https://expired.badssl.com/

//             // press enter for execute send input


//             // ipc.send("SuccessCheck_url");

//             //===============================================================================================

//             console.log('sslChecker Successful')
//             resolve()
//         }, 500)
//     })
// }

// function checkLocation() {
//     return new Promise(function (resolve, reject) {
//         setTimeout(function () {

//             // check Location

//             const dns = require("dns");

//             cleanURL().then(function (url) {
//                 dns.lookup(url, (err, address, family) => {

//                     if (err) {
//                         document.getElementById('Location_icon').style.color = 'green'
//                         console.error(`DNS lookup failed: ${err}`);
//                     } else {
//                         console.log(`IP address: ${address}`);
//                         console.log(`Address family: IPv${family}`);

//                         const https = require('https');

//                         https.get('https://ipinfo.io/' + address + '/json', (res) => {
//                             let data = '';

//                             res.on('data', (chunk) => {
//                                 data += chunk;
//                             });

//                             res.on('end', () => {
//                                 const location = JSON.parse(data);
//                                 console.log(`City: ${location.city}`);
//                                 console.log(`Region: ${location.region}`);
//                                 console.log(`Country: ${location.country}`);




//                                 // https://restcountries.com/#api-endpoints-v2-full-name
//                                 // https://restcountries.com/v2/name/US?fullText=true

//                                 const https = require('https');

//                                 https.get('https://restcountries.com/v2/name/' + location.country + '?fullText=true', (res) => {
//                                     // https://restcountries.com/v2/name/{name}?fullText=true
//                                     let data_country = '';

//                                     res.on('data', (chunk2) => {
//                                         data_country += chunk2;
//                                     });

//                                     res.on('end', () => {
//                                         const country = JSON.parse(data_country)[0];
//                                         console.log(`Full name: ${country.name}`);
//                                         document.getElementById('countryServer').innerHTML = country.name
//                                         document.getElementById('Location_icon').style.color = 'green'

//                                     });

//                                 }).on('error', (err) => {
//                                     document.getElementById('Location_icon').style.color = 'red'

//                                     console.error(`API request failed: ${err}`);
//                                     // document.getElementById('country_server').innerHTML = err
//                                 });


//                                 // document.getElementById('country').innerHTML = location.country


//                             });

//                         }).on('error', (err) => {
//                             document.getElementById('Location_icon').style.color = 'red'

//                             console.error(`IP geolocation failed: ${err}`);
//                         });
//                     }
//                 });
//             })
//             console.log('check Location')



//             console.log('Check Location Successful')
//             resolve()
//         }, 500)
//     })
// }

function checkWebServerEngineHTTP() {
    return new Promise(function (resolve, reject) {
        setTimeout(function () {

            cleanURL().then(function (url) {
                // check Engine HTTP

                const https = require('https');

                console.log('check Engine HTTP')
                // `https://${check.startsWith("www.") ? check : "www." + check}`;
                https.get(`https://${url.startsWith("www.") ? url : "www." + url}`, (res) => {
                    let header = res.headers['server'];
                    console.log(`The HTTP server engine is: ${header}`);

                    if (header == undefined) {
                        document.getElementById('Engine_HTTP_icon').style.color = '#969d52'
                        document.getElementById('serverHTTP').innerHTML = header
                    } else {
                        document.getElementById('Engine_HTTP_icon').style.color = 'green'
                        document.getElementById('serverHTTP').innerHTML = header
                    }

                });
            })


            console.log('Check Engine HTTP Successful')
            resolve()
        }, 500)
    })
}

async function scanSite() {
    await certificateChecker()
    await checkLocation()
    await checkWebServerEngineHTTP()
    console.log('Scan Site Successful')
}


// const sslChecker = require("ssl-checker");

scan.addEventListener("click", () => {
    // scanSite()

    let check = document.getElementById("linkToScan").value;
    // let showResult = document.getElementById("cerResults");

    let sslChecker = require("ssl-checker")


    // let daysRemaining = "Time remaining "+result['daysRemaining']+ " day"
    // let validate = "Validate = "+result['valid']
    // let validFrom = "Start valid from "+result['validFrom']
    // let validTo = "Expire valid to "+result['validTo']


    console.log(check)
    console.log('clean URL')
    let url = ''
    if (check.includes("://")){
        url = new URL(check).hostname
    } else {
        url = check
    }


    // let url = new URL(check).hostname
    // console.log(url)
    console.log('yo')




    // check certificate valid

    console.log('check certificate valid')


        console.log(url)
        sslChecker(url, "GET", 443).then((result) => {
            let res = result["daysRemaining"]
            let daysRemaining = "Time remaining " + result["daysRemaining"] + " day";
            let validate = "Validate = " + result["valid"];
            let validFrom = "Start valid from " + new Date(result["validFrom"]).toLocaleString();
            let validTo = "Expire valid to " + new Date(result["validTo"]).toLocaleString();
            let validFor = "Valid for " + result["validFor"];

            let check_day = Math.sign(result['daysRemaining'])

            // console.log(res)
            // console.log(daysRemaining)
            // console.log(validate)
            // console.log(validFrom)
            // console.log(validTo)
            // console.log(validFor)
            // console.log(check_day)

            // showResult.innerHTML = daysRemaining;
            // document.getElementById("daysRemaining").innerHTML = daysRemaining;
            // document.getElementById("validate").innerHTML = validate;
            // document.getElementById("validFrom").innerHTML = validFrom;
            // document.getElementById("validFrom").innerHTML = validFrom;
            // document.getElementById("validTo").innerHTML = validTo;
            // document.getElementById("validFor").innerHTML = validFor;

            console.log('Math.sign = ' + Math.sign(result['daysRemaining']));
            console.log(validate)

            if (result["valid"] == true && check_day == 1) {
                switch (Math.sign(result['daysRemaining'])) {
                    case 1:
                        document.getElementById('Certificate_icon').style.color = 'green'
                        document.getElementById("dayremaining").innerHTML = res + ' remaining';
                        console.log('มันเข้า 1 ด้วย')
                        break
                    case -1:
                        document.getElementById('Certificate_icon').style.color = 'red'
                        document.getElementById("dayremaining").innerHTML = daysRemaining + ' day expired';
                        console.log('มันเข้า -1 ด้วย')
                        break
                    case 0:
                        document.getElementById('Certificate_icon').style.color = 'red'
                        document.getElementById("dayremaining").innerHTML = 'Today expired';
                        console.log('มันเข้า 0 ด้วย')
                        break
                    case -0:
                        document.getElementById("dayremaining").innerHTML = '-0';
                        console.log('มันเข้า -0 ด้วย')
                        break
                    case NaN:
                        document.getElementById("dayremaining").innerHTML = 'NaN';
                        console.log('มันเข้า NaN ด้วย')
                        break
                    default:
                        document.getElementById("dayremaining").innerHTML = 'อยู่เหนือความคาดหมาย';
                        break

                }
            } else if (result["valid"] == true && check_day == -1) {
                document.getElementById('Certificate_icon').style.color = 'red'
                document.getElementById("dayremaining").innerHTML = 'not extend validate';
            } else if (result["valid"] == false) {
                document.getElementById('Certificate_icon').style.color = 'red'
                document.getElementById("dayremaining").innerHTML = 'Fake validate';
            }


            // test only
            // document.getElementById('Certificate_icon').style.color = 'green'
            // document.getElementById("dayremaining").innerHTML = daysRemaining+' remaining';
            // test only

        });






    // wrong.host.badssl.com
    // https://badssl.com/
    // https://expired.badssl.com/

    // press enter for execute send input


    // ipc.send("SuccessCheck_url");

    //===============================================================================================


    const dns = require("dns");

    dns.lookup(url, (err, address, family) => {

        if (err) {
            document.getElementById('Location_icon').style.color = 'green'
            console.error(`DNS lookup failed: ${err}`);
        } else {
            console.log(`IP address: ${address}`);
            console.log(`Address family: IPv${family}`);

            const https = require('https');

            https.get('https://ipinfo.io/' + address + '/json', (res) => {
                let data = '';

                res.on('data', (chunk) => {
                    data += chunk;
                });

                res.on('end', () => {
                    const location = JSON.parse(data);
                    console.log(`City: ${location.city}`);
                    console.log(`Region: ${location.region}`);
                    console.log(`Country: ${location.country}`);




                    // https://restcountries.com/#api-endpoints-v2-full-name
                    // https://restcountries.com/v2/name/US?fullText=true

                    const https = require('https');

                    https.get('https://restcountries.com/v2/name/' + location.country + '?fullText=true', (res) => {
                        // https://restcountries.com/v2/name/{name}?fullText=true
                        let data_country = '';

                        res.on('data', (chunk2) => {
                            data_country += chunk2;
                        });

                        res.on('end', () => {
                            const country = JSON.parse(data_country)[0];
                            console.log(`Full name: ${country.name}`);
                            document.getElementById('countryServer').innerHTML = country.name
                            document.getElementById('Location_icon').style.color = 'green'

                        });

                    }).on('error', (err) => {
                        document.getElementById('Location_icon').style.color = 'red'

                        console.error(`API request failed: ${err}`);
                        // document.getElementById('country_server').innerHTML = err
                    });


                    // document.getElementById('country').innerHTML = location.country


                });

            }).on('error', (err) => {
                document.getElementById('Location_icon').style.color = 'red'

                console.error(`IP geolocation failed: ${err}`);
            });
        }
    });




    // check Engine HTTP

    const https = require('https');

    console.log('check Engine HTTP')
    // `https://${check.startsWith("www.") ? check : "www." + check}`;
    https.get(`https://${url.startsWith("www.") ? url : "www." + url}`, (res) => {
        let header = res.headers['server'];
        console.log(`The HTTP server engine is: ${header}`);

        if (header == undefined) {
            document.getElementById('Engine_HTTP_icon').style.color = '#969d52'
            document.getElementById('serverHTTP').innerHTML = header
        } else {
            document.getElementById('Engine_HTTP_icon').style.color = 'green'
            document.getElementById('serverHTTP').innerHTML = header
        }

    });







    // ipc.send("checkIP");

    // const fetch = require('node-fetch');

    // const adminUrl = 'http://127.0.0.1/admin_welcome.php';
    // const userUrl = 'http://127.0.0.1/user_welcome.php';

    // async function checkAccessControl() {
    // const responseAdmin = await fetch(adminUrl);
    // const responseUser = await fetch(userUrl);
    // const contentAdmin = await responseAdmin.text();
    // const contentUser = await responseUser.text();

    // if (responseAdmin.ok && contentAdmin === contentUser) {
    //     console.log('Broken access control detected');
    //     document.getElementById('Web_Vulnerability_icon').style.color = 'green'
    // } else {
    //     console.log('Broken access control not detected');
    //     document.getElementById('Web_Vulnerability_icon').style.color = 'red'
    // }
    // }
    // checkAccessControl();

    // ipc.send("SuccessCheck_url");
});